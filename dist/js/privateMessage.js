/*
Change by PengWu on 2017-07-06 19:21:36
*/
define("privateMessage",function(require,exports,module){var e,t=require("base/vars"),i=require("base/util"),s=require("base/url"),n=require("base/action"),a=(require("base/scroll"),require("trace/pv")),o=require("trace/click"),r=require("upload"),l=require("tip"),c=require("env"),d=(require("message"),require("iscroll/iscroll-zoom"),t.UA.toLowerCase(),t.ScreenSize.split("x")[1]),u=(window.location.href,window.location.host),h=document.location.protocol,p=s.getParam("otherUid"),m=!1,g=!0,f=!0,v=0,w=1,T={},k="",y=new IScroll("#wrapper",{hScrollbar:!1,vScrollbar:!1,checkDOMChanges:!0}),b=($(window),$(document),$("#wrapper")),x=$("#messageList"),C=$("#contentInput"),L=$("#displayLayer"),S=$("#sendBox"),P=$("#uploadPic"),H=$("#loading"),M=$("#sendTemplate"),O=$("#listTemplate"),I={myHost:t.PROTOCOL+"my.tv.sohu.com",apiHost:t.API_URL,realTimeRouter:t.PROTOCOL+"my.tv.sohu.com/user/private/api/router.do"};/my\.test\.56\.com|my\.test\.sohu\.com|127\.0\.0\.1|localhost/.test(u)||"file:"===h?(I.myHost=t.PROTOCOL+"my.test.sohu.com/pxy2",I.apiHost=t.PROTOCOL+"dev.app.yule.sohu.com/",m=!0,T.passport="A811C575533EB5EF758B212321B1AFCC@qq.sohu.com",T.token="03d2dd4d3b723fdc91f32d1dee7707d1",T.uid="6FBF1C2E-1B6B-45EB-81A2-F70D82FA6EC6",T.plat="3",T.sver="6.6"):/t\.m\.tv\.sohu\.com|mobile\.m\.56\.com/i.test(u)&&(I.myHost=t.PROTOCOL+"10.10.92.140",I.apiHost=t.PROTOCOL+"dev.app.yule.sohu.com/");var V={apiUrls:{producerInfo:I.apiHost+"v4/user/info/"+p+".json",privateMessage:I.myHost+"/user/a/message/"},query:{valid:0,to_uid:p,passport:T.passport,token:T.token,uid:T.uid,plat:T.plat,sver:T.sver,size:10},address:{privateletterListV2:"privateletter_list_v2.do",updateReadall:"update_readall.do",detailPrivateLetterV2:"detail_privateletter_v2.do",privateletterUserinfoV2:"privateletter_userinfo_v2.do",sendPrivateLetter:"send_privateletter.do"},apiKey:{api_key:t.API_KEY}},B=function(e){return 1===e.toString().length&&(e="0"+e),e},E=Bone.Model.extend({initialize:function(e,t){t=t||e||{},this.url=t.apiUrls.producerInfo,this.urlData=t.apiKey,this.fetch()},parse:function(e,t){k=e&&200===e.status&&e.data.nickname?e.data.nickname:"私信会话页",c.setPageTitle(k)}}),z=Bone.Model.extend({initialize:function(e,t){t=t||e||{},this.url=t.apiUrls.privateMessage+t.address.detailPrivateLetterV2,this.urlData=_.pick(t.query,["valid","to_uid","passport","token","size"])},parse:function(e,t){var i=this;e&&(200===e.status&&(i.attributes.data=e.data.reverse()),i.trigger("response",e))}}),A=Bone.Model.extend({initialize:function(e,t){t=t||e||{},this.url=t.apiUrls.privateMessage+t.address.sendPrivateLetter,this.urlData=_.pick(t.query,["valid","to_uid","passport","token"])},parse:function(e,t){var i=this;e&&(200===e.status?(i.attributes.data=e.data,i.trigger("response",e.data)):i.trigger("response",e))}}),U=Bone.View.extend({template:Handlebars.compile(O.html()),initialize:function(){this.listenTo(this.model,"response",this.render)},render:function(){var e=this.getTemplate();return Bone.Renderer.render(e,this.model)}}),D=Bone.View.extend({el:x,events:{"touchstart .text .content .info":"deleteStart","touchend .text .content .info":"deleteEnd","touchstart .text .content a":"touchStartLink","touchend .text .content a":"touchEndLink","tap .picture .content .image":"tapPicture","tap .video .content":"tapVideo"},initialize:function(){this.listenTo(this.model,"response",this.render),this.scrollList(),this.model.urlData.page=w,this.model.fetch({success:function(e,t,s){if(200===t.status&&10===t.data.length){w+=1;var n={data:t.data,self:t.self,touser:t.touser};window.localStorage&&!localStorage.getItem("primsg-to_uid:"+t.touser.toUid)&&localStorage.setItem("primsg-to_uid:"+t.touser.toUid,i.JSONStringify(n))}else g=!1}})},render:function(e){var t=this;if(t.listTemplateView=new U({model:e}),t.$el.prepend(t.listTemplateView.render()),t.checkPic(e.data),f){if(t.firstLoad(),t.$el.find(".picture")){var i=t.$el.find(".picture").length;console.log(t.$el.find(".picture").length);setTimeout(function(){t.$el.removeClass("list-loading"),f=!1},200*i);return}return t.$el.removeClass("list-loading"),void(f=!1)}t.onceAgainLoad(e.data),t.loadingFinish()},scrollList:function(){var e=this;y.on("scrollStart",function(){this.y===this.maxScrollY&&this.distY>0&&C.blur()}),y.on("scrollEnd",function(){this.y>=-200&&this.distY>0&&g&&(e.loadingStart(),e.model.urlData.page=w,e.model.fetch({success:function(e,t,i){200===t.status&&10===t.data.length?w+=1:g=!1}}))})},deleteStart:function(){this.deleteTimer=setTimeout(function(){alert("delete")},800)},deleteEnd:function(){clearTimeout(this.deleteTimer)},touchStartLink:function(e){$(e.currentTarget).addClass("highlight")},touchEndLink:function(e){$(e.currentTarget).removeClass("highlight")},checkPic:function(e){var t=e.length+1;this.$el.find(".picture .content img").on("load",function(){var e=this,i=$(e).width();$(e).height()/i>2&&$(e).width("auto").height(150),y.refresh(),f?y.scrollToElement(document.querySelector("#messageList .message-box:last-child"),100,null,null):y.scrollToElement(document.querySelector("#messageList .message-box:nth-child("+t+")"),100,null,null)})},tapPicture:function(e){var t=$(e.currentTarget).find("img").attr("src");this.displayLayerView=new F({model:t})},tapVideo:function(){var e=this.$el.find(".video .content"),i={action:"1.1",type:"click",cid:e.data("cid")||"",vid:e.data("vid")||"",site:2,channeled:"1000140002",more:{sourcedata:{channeled:"1000140002"}}};t.IsIOS?window.location.href=n.makeActionUrl(i):n.sendAction(i)},firstLoad:function(){setTimeout(function(){y.refresh(),y.scrollToElement(document.querySelector("#messageList .message-box:last-child"),100,null,null)},0)},onceAgainLoad:function(e){var t=e.length+1;setTimeout(function(){y.refresh(),y.scrollToElement(document.querySelector("#messageList .message-box:nth-child("+t+")"),100,null,null)},0)},loadingStart:function(){b.css("top","0.76rem"),H.removeClass("transparent")},loadingFinish:function(){H.addClass("transparent"),b.css("top","0")}}),q=Bone.View.extend({tagName:"li",className:"message-box",template:Handlebars.compile(M.html()),initialize:function(){this.listenTo(this.model,"response",this.render)},render:function(){var e=this.getTemplate(),t=Bone.Renderer.render(e,this.model);return this.$el.html(t),this}}),R=Bone.View.extend({el:S,events:{"focus #contentInput":"writing","keyup #contentInput":"sendText","change #uploadPic":"uploadPic"},initialize:function(){this.listenTo(this.model,"response",this.render)},render:function(e){var t=this;if(e.status&&200!=e.status)return void t.errorHint(e.status);t.sendTemplateView=new q({model:e}),x.append(t.sendTemplateView.render().el),t.checkPic();setTimeout(function(){y.refresh(),y.scrollToElement(document.querySelector("#messageList .message-box:last-child"),100,null,null)},0)},writing:function(e){setTimeout(function(){e.target.scrollIntoViewIfNeeded()},200);y.scrollToElement(document.querySelector("#messageList .message-box:last-child"),100,null,null)},sendText:function(e){13===e.keyCode&&C.val()&&(this.model.urlData.content=C.val(),this.model.urlData.content_type=2,this.model.fetch(),C.val(""))},uploadPic:function(){var e=this,t=P.get(0);void 0===t||$.isUndefined(t.files)||r.uploadImg(t,T,function(t){if(200!=t.status)return l.showTip("上传失败!",1e3),void P.val("");e.model.urlData.content=c.fixImgHttp(t.data.img),e.model.urlData.content_type=3,e.model.fetch(),P.val("")},m),this.traceClick()},checkPic:function(){x.find(".picture .content img").on("load",function(){var e=this,t=$(e).width();$(e).height()/t>2&&($(e).width("auto").height(150),y.refresh(),y.scrollToElement(document.querySelector("#messageList .message-box:last-child"),100,null,null))})},errorHint:function(e){var t="";switch(e){case 1:t="未绑定手机号";break;case 2:t="接收方不存在";break;case 3:t="发送次数超标";break;case 4:t="验证码不对";break;case 5:t="被对方加入了黑名单";break;case 6:t="只有粉丝才能发送";break;case 7:t="敏感内容";break;case 8:t="空内容";break;case 9:t="发送失败";break;case 31:t="自己不能给自己发私信";break;case 101:t="参数错误";break;case 117:t="没有登录";break;case 500:t="系统错误";break;default:t="发送失败"}l.showTip(t,1e3)},traceClick:function(){o.pingback(null,"sx_chatu_click",{remark:"私信页-发送图片"},function(){})}}),F=Bone.View.extend({el:L,events:{click:"close",dblclick:"zoom"},initialize:function(){this.$el.find("img").attr("src",this.model),this.$el.show(),this.open()},open:function(){var t=this;setTimeout(function(){var e=t.$el.find("img");e.height()>=d?(e.removeClass("wide").addClass("long"),e.css({"margin-left":"-"+e.width()/2+"px"})):(e.removeClass("long").addClass("wide"),e.css({"margin-top":"-"+e.height()/2+"px"})),e.removeClass("reset")},0);e=new IScroll("#displayLayer",{zoom:!0,zoomStart:1,scrollX:!0,scrollY:!0,mouseWheel:!0,wheelAction:"zoom",click:!0})},zoom:function(){alert("dblclick")},close:function(){e.destroy(),this.$el.hide(),this.$el.find("img").removeClass("long").addClass("wide reset").css({"margin-top":"0px","margin-left":"0px"})}}),N=Bone.Object.extend({initialize:function(e){var t=this;this.producerInfo=new E(e),this.listMessageModel=new z(e),this.listView=new D({model:this.listMessageModel}),this.sendMessageModel=new A(e),this.sendView=new R({model:this.sendMessageModel}),this.realTimeMessage=new dolphin.MyMessage({router:I.realTimeRouter,channel:"/p/",message:t.onMessage,error:t.onError,passport:T.passport,token:T.token}),this.realTimeMessage.start()},onMessage:function(e){console.log(e)},onError:function(e){console.log(e)}}),Y=Bone.Application.extend({initialize:function(e){this.getClientInfo(e),this.sendPV()},getClientInfo:function(e){if(m)return $.extend(V,e||{}),void(this.presents=new N(V));var t=setInterval(function(){window.SohuAppPrivates?(T=i.JSONParse(window.SohuAppPrivates),$.extend(V,e||{}),this.presents=new N(V),clearInterval(t)):(v+=1)>50&&(l.showTip("无法获取用户信息",1e3),clearInterval(t))},50)},sendPV:function(){a.pv()}});module.exports={init:function(e){new Y(e).start(e)}},Handlebars.registerHelper("sender",function(e){var t="";return e!=s.getParam("otherUid")&&(t=" mein"),t}),Handlebars.registerHelper("messageType",function(e){var t;return 1==e?t="topic":2==e?t="text clear":3==e?t="picture clear":4==e?t="video clear":5==e&&(t="topic"),t}),Handlebars.registerHelper("senderMessageType",function(e){return/^<img/.test(e)?"picture clear":"text clear"}),Handlebars.registerHelper("hasPortrait",function(e,t){if(1!=e&&5!=e)return t.fn(this)}),Handlebars.registerHelper("messageContent",function(e){var t="",s=e.contentType,n=i.JSONParse(e.content);if(1==s)t+='<a href="'+n.topic_url_h5+'" class="link"><h6 class="title">'+n.title+"</h6>",n.coverUrl&&(t+='<div class="image"><img src="'+n.coverUrl+'" width="100%"></div>'),t+="</a>";else if(2==s)t+='<div class="content"><p class="info">'+e.content.replace(/&lt;/g,"<").replace(/&gt;/g,">")+"</p></div>";else if(3==s)t+='<div class="content"><div class="image">'+e.content+"</div></div>";else if(4==s)t+='<div class="content" data-url="'+n.video_url_h5+'" data-cid="'+n.cid+'" data-vid="'+n.vid+'" data-cateCode="'+n.cate_code+'"><div class="info clear"><h6 class="title">'+n.video_name+"</h6>",n.cover&&(t+='<div class="thumbnail image"><img src="'+n.cover+'" width="100%" /></div>'),t+="</div></div>";else if(5==s&&(t='<a href="'+n[0].urlh5+(1==n[0].type?"&star_name="+k:"")+'" class="link"><h6 class="title">'+(1==n[0].type?"#"+n[0].title+"#":n[0].title)+'</h6><div class="image"><img src="'+n[0].cover+'" width="100%"></div></a>',n.length>1)){var a;for(t+='<ul class="multi-topic">',a=1;a<n.length;a+=1)t+='<li class="clean"><a href="'+n[a].urlh5+(1==n[a].type?"&star_name="+k:"")+'"><h6 class="title"><span class="span">'+(1==n[a].type?"#"+n[a].title+"#":n[a].title)+"</span></h6>"+(n[a].cover?'<div class="image"><img src="'+n[a].cover+'" width="100%"></div>':"")+"</a></li>";t+="</ul>"}return t}),Handlebars.registerHelper("sendMessageContent",function(e){var t="";return t+=/^<img/.test(e)?'<div class="content"><div class="image">'+e+"</div></div>":'<div class="content"><p class="info">'+e+"</p></div>"}),Handlebars.registerHelper("day",function(e){var t=new Date(e);return t.getFullYear()+"-"+B(t.getMonth()+1)+"-"+B(t.getDate())}),Handlebars.registerHelper("time",function(e){var t=new Date(e);return B(t.getHours())+":"+B(t.getMinutes())})});
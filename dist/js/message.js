/*
Change by PengWu on 2017-07-06 19:21:36
*/
this.dolphin=this.dolphin||{},dolphin.DefaultMessage=function(e){console.log("call default function, please init your 'message' function.")},dolphin.Transport=function(e,o,n){this.config=dolphin.extends(e),this.handleMessage=o,this.retryConnect=n},dolphin.Transport.prototype.connect=function(){return!1},dolphin.Transport.prototype.reconnect=function(){console.log("fire transport close"),this.retryConnect()},dolphin.extends=function(e){function o(){}return o.prototype=e,new o},dolphin.WebSocketTransport=function(e){_self=dolphin.extends(e);var o,n=_self.config.url,t=function(){console.log("call heartbeat"),o=setInterval(function(){console.log("trigger heartbeatInterval"),_self.ws.send(_self.config.heartbeat())},_self.config.timeout)};return _self.connect=function(){console.log("connect to "+n);var e=new WebSocket(n);_self.ws=e;var s=setTimeout(function(){console.log("Socket connection timeout readyState:%d",e.readyState),e.close()},_self.config.connect_timeout);e.onopen=function(){s&&clearTimeout(s),console.log("WebSocket connect success."),e.send(_self.config.handshake())},e.onerror=function(e){console.log("fire ws.onerror")},e.onclose=function(){o&&clearInterval(o),s&&clearTimeout(s),console.log("WebSocket connection close",e.readyState),_self.reconnect()},e.onmessage=function(o){if(o&&o.data){var n=JSON.parse(o.data),s=_self.handleMessage(n);if(s==dolphin.Operation.OP_HANDSHAKE_REPLY&&t(),dolphin.isOpSuccess(s))return}e.close()}},_self},dolphin.isOpSuccess=function(e){return e!=dolphin.Operation.OP_SYSTEM_ERROR&&e!=dolphin.Operation.OP_DISCONNECT&&e!=dolphin.Operation.OP_DISCONNECT_REPLY},dolphin.JsonpPollingTransport=function(e){_self=dolphin.extends(e);var o=_self.config.url,n=0;_self.active=function(){n=(new Date).valueOf()},_self.connect=function(){console.log("connect to "+o),r(_self.config.handshake(),_self.config.connect_timeout)};var t=function(e){dolphin.isOpSuccess(e)?setTimeout(s,_self.config.delay):_self.reconnect()},s=function(){r(_self.config.heartbeat())},r=function(e,n){$.ajax({url:o,timeout:n,data:"message="+e,dataType:"jsonp",callback:"helloworld",callbackParameter:"callback",success:function(e){console.log("call jsonp success"),e&&(t(_self.handleMessage(e)),console.log("jsonp success result"))},error:function(e,o,n){console.log("jsonp error"),t(dolphin.Operation.OP_SYSTEM_ERROR)}})};return _self},dolphin.Operation={OP_SYSTEM_ERROR:0,OP_HANDSHAKE:1,OP_HANDSHAKE_REPLY:2,OP_PING:3,OP_PONG:4,OP_DISCONNECT:5,OP_DISCONNECT_REPLY:6,OP_SEND_SMS:20,OP_SEND_SMS_REPLY:21},dolphin.MyMessage=function(e){var o={channel:"/p/",message:dolphin.DefaultReceive,passport:"",token:"",debug:!0,connect_timeout:2e3,delay:1e3,router:"http://127.0.0.1:9001/private/api/router.do"};this.config=e||{},this.config.channel=this.config.channel||o.channel,this.config.message=this.config.message||o.message,this.config.passport=this.config.passport||o.passport,this.config.token=this.config.token||o.token,this.config.debug=this.config.debug||o.debug,this.config.delay=this.config.delay||o.delay,this.config.connect_timeout=this.config.connect_timeout||o.connect_timeout,this.config.router=this.config.router||o.router;var n,t,s=this,r=1,c="",a=!1,l=[];this.config.handshake=function(){return JSON.stringify({ver:1,op:dolphin.Operation.OP_HANDSHAKE,seq:r,ch:n,data:{passport:s.config.passport,token:s.config.token}})},this.config.heartbeat=function(){return JSON.stringify({ver:1,op:dolphin.Operation.OP_PING,seq:r,ch:n,data:{clid:c}})},this.handle=function(e){var o=dolphin.Operation.OP_SYSTEM_ERROR;if(e&&e.length){r++;for(i in e){if(!(e[i]&&e[i].op>dolphin.Operation.OP_SYSTEM_ERROR&&e[i].data))break;var n=[];switch(o=e[i].op,e[i].op){case dolphin.Operation.OP_HANDSHAKE_REPLY:console.log("receive handshake message"),c=e[i].data.clid;break;case dolphin.Operation.OP_PONG:console.log("receive pong message");break;case dolphin.Operation.OP_SEND_SMS_REPLY:n.push(e[i].data);break;case dolphin.Operation.OP_DISCONNECT_REPLY:console.log("receive disconnect message");break;default:console.log("ignore op:%d, data:%s",e[i].op,e[i].data)}var t=s.config.message;t&&n.length&&(console.log("receive push message"),t(n))}}return o},this.retry=function(){a&&(console.log((new Date).getTime()),t=setTimeout(s.current_transport.connect,5e3))};var p=function(){r=1,c=0,t&&clearTimeout(t)};this.stop=function(){a&&(a=!1,p())};this.start=function(){a||(f={},this.callRouter())};var f={};this.browserTransport=function(){return{websocket:!1,jsonp:!0}},this.getCurrentTransport=function(e){a=!0,e&&e.num?(console.log("get serverTrans success"),s.current_transport=s.getAllowTransport(),console.log("start message %s",a),s.current_transport.connect()):console.log("get serverTrans fail")},this.getAllowTransport=function(){var e=s.browserTransport();if(e.websocket&&f.websocket){var o=dolphin.extends(s.config);o.url=f.websocket.url,n=f.websocket.ch,o.server=f.websocket.server,o.timeout=f.websocket.timeout,o.transport=f.websocket.transport,transport=new dolphin.Transport(o,s.handle,s.retry),l.push(new dolphin.WebSocketTransport(transport))}if(e.jsonp&&f.jsonp){var o=dolphin.extends(s.config);o.url=f.jsonp.url,n=f.jsonp.ch,o.server=f.jsonp.server,o.timeout=f.jsonp.timeout,o.transport=f.jsonp.transport,transport=new dolphin.Transport(o,s.handle,s.retry),l.push(new dolphin.JsonpPollingTransport(transport))}return l[0]},this.callRouter=function(){$.ajax({url:s.config.router,timeout:s.config.connect_timeout,data:"passport="+s.config.passport+"&token="+s.config.token+"&ch="+s.config.channel,dataType:"jsonp",callback:"hello",callbackParameter:"callback",success:function(e){if(console.log("get router success"),e&&e.length){for(i in e)f[e[i].transport]=e[i],f.num=i;s.getCurrentTransport(f)}},error:function(e,o,n){console.log("get router failed")}})}};